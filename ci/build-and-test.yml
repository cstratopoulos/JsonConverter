# Ossiaco JSON Converter Library
# 
# Copyright (C) 2018 Ossiaco
# 
# Licensed under the MIT license ("the license"); you may not use this file
# except in compliance with the license. The license can be found in the root
# directory of this project, or at
# 
# http://opensource.org/licenses/MIT

steps:
  - bash: conan install ../ ${CONAN_OPTS:-} -s build_type=${BUILD_TYPE} --build missing
    displayName: 'Conan install deps'
    workingDirectory: $(DEPS_DIR)

  - task: CMake@1
    inputs:
      workingDirectory: 'build'
      cmakeArgs: "-DCMAKE_BUILD_TYPE=$(BUILD_TYPE) $(CMAKE_OPTS) .."
    displayName: 'CMake Generate'

  - task: CMake@1
    inputs:
      workingDirectory: 'build'
      cmakeArgs: "--build . --parallel 4"
    displayName: 'CMake Build'

  - bash: |
      echo "##vso[task.setvariable variable=RUN_VALGRIND]1"
      ctest -V
    displayName: 'Test suite'
    workingDirectory: build

  - bash: valgrind --leak-check=full --error-exitcode=1 ctest -V
    displayName: 'Valgrind test suite'
    workingDirectory: build
    condition: and(eq(variables['Agent.OS'], 'Linux'), eq(variables['RUN_VALGRIND'], '1'))
