# Ossiaco JSON Converter Library
# 
# Copyright (C) 2018 Ossiaco
# 
# Licensed under the MIT license ("the license"); you may not use this file
# except in compliance with the license. The license can be found in the root
# directory of this project, or at
# 
# http://opensource.org/licenses/MIT

steps:
  - bash: |
      set -eux
      mkdir -p ${DEPS_DIR}
      cd ${DEPS_DIR}
      pwd
    displayName: 'Ensure deps directory exists'

  - bash: |
      set -eux
      pip --version
      ${PIP_CMD} install --upgrade pip setuptools wheel
    displayName: 'Setup and Update pip'

  - bash: |
      set -eux
      ${PIP_CMD} install conan
      conan --version
      conan remote add bincrafters https://api.bintray.com/conan/bincrafters/public-conan
    displayName: 'Install conan'

  - bash: |
      set -eu
      echo "##vso[task.setvariable variable=CONAN_OPTS]$(CONAN_OPTS) -s compiler=gcc -s compiler.libcxx=libstdc++11 -s compiler.version=${CXX//g\+\+\-/}"
    displayName: 'Set gcc conan opts'
    condition: and(succeeded(), startsWith(variables['CXX'], 'g++'))

  - bash: |
      set -eu
      echo "##vso[task.setvariable variable=CONAN_OPTS]$(CONAN_OPTS) -s compiler.libcxx=libc++"
    displayName: 'Set clang conan opts'
    condition: and(succeeded(), startsWith(variables['CXX'], 'clang'))

  - bash: |
      set -eu
      echo "##vso[task.setvariable variable=CONAN_OPTS]"
    displayName: 'Set XCode conan opts'
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin'))

  - bash: |
      set -eu
      echo "##vso[task.setvariable variable=CMAKE_OPTS]$(CMAKE_OPTS) ${EXTRA_CMAKE_OPTS:-}"
    displayName: 'Append extra cmake opts if any'

  - bash: |
      set -eux
      sudo apt install valgrind
    displayName: 'Get valgrind'
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'))
